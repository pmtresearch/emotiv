'use strict';

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var join = require('path').join;
var spawnSync = require('child_process').spawnSync;
var ansiEscapes = require('ansi-escapes');
var getCursorPosition = require('@patrickkettner/get-cursor-position');

var isWin = process.platform === 'win32';
var SHELL = isWin ? 'powershell' : '/bin/bash';
var PAGER_COMMAND_LOC = '../helpers/pager' + (isWin ? '.ps1' : '');

/**
 * Output the given text into a pager (less). First move the cursor to the top
 * left corner, otherwise the text may appear off. On exit, return the cursor
 * to its original position.
 *
 * @param {string} text - A string of text.
 * @return {promise}
 */
var pager = function pager(text) {
  return new Promise(function (resolve) {
    var pos = getCursorPosition.sync();
    process.stdout.write(ansiEscapes.cursorTo(0, 0));

    var pagerCommand = join(__dirname, PAGER_COMMAND_LOC);
    var args = [pagerCommand, text];
    if (isWin) args = ['-File'].concat(_toConsumableArray(args));
    spawnSync(SHELL, args, { stdio: 'inherit' });

    setTimeout(function () {
      process.stdout.write(ansiEscapes.cursorTo(pos.col - 1, pos.row - 1));

      // I think this works? resolve seems to execute only after the pager is exited.
      resolve();
    }, 0);
  });
};

module.exports = pager;