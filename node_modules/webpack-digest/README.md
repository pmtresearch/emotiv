<div align="center">
    <img alt="Webpack Digest Crane" src="https://gitlab.com/wallzero/webpack-digest/raw/master/src/favicon.png" />
</div><br>

<div align="center">
  <h1>Webpack Digest</h1>
</div>

<div align="center">
<a href="https://commitizen.github.io/cz-cli/"><img alt="Commitizen Friendly" src="https://img.shields.io/badge/commitizen-friendly-brightgreen.svg?maxAge=2592000" /></a>
<a href="https://gitlab.com/hyper-expanse/semantic-release-gitlab#readme"><img alt="Semantic Release" src="https://img.shields.io/badge/%20%20%F0%9F%93%A6%F0%9F%9A%80-semantic--release-e10079.svg?maxAge=2592000" /></a>
</div>

<div align="center">
<a href="https://gitlab.com/wallzero/webpack-digest/commits/master"><img alt="Build Status" src="https://gitlab.com/wallzero/webpack-digest/badges/master/build.svg" /></a>
<a href="https://wallzero.gitlab.io/webpack-digest/coverage"><img alt="Coverage Report" src="https://gitlab.com/wallzero/webpack-digest/badges/master/coverage.svg" /></a>
<a href="https://www.npmjs.org/package/webpack-digest"><img alt="NPM Version" src="http://img.shields.io/npm/v/webpack-digest.svg?maxAge=86400" /></a>
<a href="https://www.gnu.org/licenses/gpl-3.0.en.html"><img alt="License" src="https://img.shields.io/npm/l/webpack-digest.svg?maxAge=2592000" /></a>
<a href="https://app.fossa.io/projects/git%2Bhttps%3A%2F%2Fgitlab.com%2Fwallzero%2Fwebpack-digest?ref=badge_shield"><img alt="FOSSA Status" src="https://app.fossa.io/api/projects/git%2Bhttps%3A%2F%2Fgitlab.com%2Fwallzero%2Fwebpack-digest.svg?type=shield&maxAge=3600" /></a>
<a href="https://github.com/gajus/canonical"><img alt="Canonical Code Style" src="https://img.shields.io/badge/code%20style-canonical-blue.svg?maxAge=2592000" /></a>
</div>

<h2> </h2>

**Webpack Digest** is a reusable and
*extendable* [Webpack](https://webpack.js.org/)
configuration while doing the tedious configuration for you.

The provided Webpack configuration offers sane defaults for common loaders and plugins.
Assets include `.html`, `.css`, `.js`, `.svg`, `.png`, `.jpg`, `.ico`,
`.gif`, `.woff(2)`, `.eot`, and `.ttf`. Additional loaders are configured for
React (`.jsx`), Typescript (`.ts`, `.tsx`), and Sass (`.sass`, `.scss`).
Defaults for `index.html`, `favicon`, linters (`eslint`, `tslint`, `stylelint`),
`babel`, and `express` are configured - but can be overridden or extended.
Minification, asset extraction, `manifest.js` and `vendor.js` extraction, and
file hashes, and whole lot more are preconfigured. In development environments,
source minification is skipped, source maps are lazily generated, and
`webpack-dev-middleware` and `webpack-hot-middleware` are configured with the
provided `express` scripts. A [Jest](#jest) config is provided and works with
Typescript. A [Nightwatch](#nighwatch) config is also provided. `workbox` is
configured to provide basic WebApp service worker and cache support. A library
mode can be set to output proper minified `umd` builds with no dependencies.

**[Click here to see working build demos](http://wallzero.gitlab.io/webpack-digest/)**

*Warning: this project is still alpha quality with possible breaking changes
with each release. Angular2's Hot Loader are in progress.*

## Install

```bash
npm install --save-dev webpack-digest
```

It's also suggested `cross-env` is installed globally to assist with
cross-platform environment variable definitions required in the `package.json`
scripts.

```bash
npm install -g cross-env
```

## Setup

### npm

To use the **Webpack Digest** config, create a `webpack.config.js` file in the
root of your project and import:

```js
'/webpack.config.js'

var webpackDigest = require('webpack-digest/lib/webpack.config.js');

module.exports = return webpackDigest;
```

This file is automatically picked up by the `webpack` command. You can also
point `webpack` directly to **Webpack Digest** with the `--config` option.

To run with npm, setup scripts in your project's `package.json`. The following
examples will perform development and production builds, host development or
production servers with `webpack-digest`'s provided `express` scripts, or clean
the build and cache directories:

```json
'/package.json'

"scripts": {
  "start": "node node_modules/webpack-digest/lib/express/start.js",
  "start:dev": "cross-env NODE_ENV='development' node node_modules/webpack-digest/lib/express/start.js",
  "build": "webpack --progress --colors --display-error-details",
  "build:dev": "cross-env NODE_ENV='development' webpack --progress --colors --display-error-details",
  "clean": "rm -rf public && rm -rf .cache/"
}
```

Once added to your `package.json`, run one of the scripts in the terminal:

```bash
npm run start:local
```

### Maven

**Webpack Digest** can also be configured in Maven projects using
[frontend-maven-plugin](https://github.com/eirslett/frontend-maven-plugin)\. To
use with Maven, set the frontend-maven-plugin arguments and environment
variables in the pom.xml:

```xml
'/pom.xml'

<execution>
  <id>webpack install</id>
  <goals>
    <goal>webpack</goal>
  </goals>
  <configuration>
    <arguments>--config node_modules/webpack-digest/lib/webpack.config.js --display-error-details</arguments>
    <environmentVariables>
      <NODE_ENV>${NODE_ENV}</NODE_ENV>
    </environmentVariables>
  </configuration>
</execution>
```

## Options

Options can be loaded from a `webpack.digest.config.json` file in the root of
your project excluding `NODE_ENV`, `DIGEST`, and `PORT` environment variables.
For example:

```json
'/webpack.digest.config.json'

{
  "platforms": {
    "cssModules": true,
    "pragma": "react",
    "typescript": true
  },
  "tsconfig": "demo/tsconfig.json"
}
```

Environment variables can also be used and take precedent. Although
`webpack.digest.config.json` is preferred to reduce verbosity in your scripts.
The examples provided demonstrate with environment variables for clarity, but
it is recommended to use them sparingly. Environment variables
make it easy to switch to `development` or override an option in the
`webpack.digest.config.json` settings. For example:

```json
'/package.json'

{
  ...
  "scripts": {
    "build": "cross-env NODE_ENV='development' STATIC_PATH='private' webpack --progress --colors --display-error-details"
    ...
  }
}
```

There are many options but **Webpack Digest** offers sane enough defaults. Most
projects should only require a few; often: `NODE_ENV` and `platforms`. The
following table lists the valid options:

| webpack.digest.config.js  | Environment Variable      | Description                                                                                                                                                         | Default                                                                      | Options                                                                                                                                                               |
|---------------------------|---------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| *n/a*                     | **NODE_ENV**              | Use either **production** or **development**. Production features include minification, while development features include linting and HMR.                         | `production`                                                                 |                                                                                                                                                                       |
| *n/a*                     | DIGEST                    | Path to **Webpack Digest** settings. It contains these settings.                                                                                                    | `/webpack.digest.config.js`                                                  |                                                                                                                                                                       |
| *n/a*                     | PORT                      | The express host port                                                                                                                                               | Default `8080`, `8090` when `NODE_ENV='development'`                         |                                                                                                                                                                       |
| baseHref                  | BASE_HREF                 | Set the provided default `index.html` base href path, e.g. `<base href=''>`. Also used by provided express and workbox configs.                                     | `/`                                                                          |                                                                                                                                                                       |
| cache                     | CACHE                     | Path to store temporary cache files                                                                                                                                 | `/node_modules/.cache/`                                                      |                                                                                                                                                                       |
| compression               | COMPRESSION               | Enable file compression                                                                                                                                             | `on`                                                                         | <code>\[on&#124;off\]</code>                                                                                                                                          |
| config                    | CONFIG                    | Path to Webpack config. See [Webpack Config](#extending) for more details.                                                                                          | `/webpack.config.js` or default config from **Webpack Digest**               |                                                                                                                                                                       |
| dashboard                 | DASHBOARD                 | Use webpack-dashboard                                                                                                                                               | `on`                                                                         | <code>\[on&#124;off\]</code>                                                                                                                                          |
| e2e                       | E2E                       | Path to end-to-end test files for Nightwatch                                                                                                                        | `/__e2e__`                                                                   |                                                                                                                                                                       |
| env                       | ENV                       | A `json` object that defines environment variables to be included by Webpack DefinePlugin. For example, `{"open": "\"sets\""}`. Accessible under `process.env`.     | `{}`                                                                         |                                                                                                                                                                       |
| eslint                    | ESLINT                    | Path to javascript eslint config                                                                                                                                    | `/.eslintrc` or defaults packaged with **Webpack Digest**                    |                                                                                                                                                                       |
| favicon                   | FAVICON                   | Path to `favicon.png`                                                                                                                                               | `/SRC_PATH/favicon.png or defaults packaged with **Webpack Digest**`         |                                                                                                                                                                       |
| headless                  | HEADLESS                  | Whether to run browsers in headless mode in selenium`                                                                                                               | `true`                                                                       |                                                                                                                                                                       |
| index                     | INDEX                     | Path to `index.htm`                                                                                                                                                 | `/SRC_PATH/index.htm or defaults packaged with **Webpack Digest**`           |                                                                                                                                                                       |
| library                   | LIBRARY                   | Toggle UMD library creation instead. This generates a bundle *without* dependencies and polyfills                                                                   | `false`                                                                      | <code>\[true&#124;false\]</code>                                                                                                                                      |
| parallel                  | PARALLEL                  | Whether to run loaders in parallel or not. Parallel will only use a maximum of n-processors minus two; but can be disabled altogether if issues still arise.        | `on`                                                                         | <code>\[on&#124;off\]</code>                                                                                                                                          |
| **platforms**             | **PLATFORMS**             | Object (webpack.digest.config.js) or Comma delimited (environment variable) list of platforms can enable different loader behaviours.                               |                                                                              | <code>{cssModules: true, pragma: '\[react\]', typescript: true, angular: true}</code> or <code>cssModules,\[react\],typescript,angular</code>                         |
| polyfills                 | POLYFILLS                 | Path to additional polyfills                                                                                                                                        | `/polyfills.js` or defaults packaged with **Webpack Digest**                 |                                                                                                                                                                       |
| postcss                   | POSTCSS                   | Path to PostCSS config                                                                                                                                              | `/postcss.config.json` or defaults packaged with **Webpack Digest**          |                                                                                                                                                                       |
| postcssWhitelist          | POSTCSS_WHITELIST         | A pipe separated whitelist of packages in `node_modules` that *should* be parsed by PostCSS                                                                         | 'reacet-toolbox'                                                             |                                                                                                                                                                       |
| pwa                       | PWA                       | Enable features for basic progressive web app functionality such as service workers and caching                                                                     | `on`                                                                         | <code>\[on&#124;off\]</code>                                                                                                                                          |
| reportPath                | REPORT_PATH               | Path to generate reports                                                                                                                                            | `/reports`                                                                   |                                                                                                                                                                       |
| seleniumPort              | SELENIUM_PORT             | The selenium port                                                                                                                                                   | `4444`                                                                       |                                                                                                                                                                       |
| seleniumStart             | SELENIUM_START            | Whether to start selenium or not; for CI integration.                                                                                                               | `true`                                                                       |                                                                                                                                                                       |
| shortName                 | SHORT_NAME                | An optional shorter name to be used in bundle generation. Useful when generating libraries.                                                                         | The `name` property in `package.json`                                        |                                                                                                                                                                       |
| sourceMaps                | SOURCE_MAPS               | Toggle source map generation                                                                                                                                        | `true`                                                                       | <code>\[true&#124;false\]</code>                                                                                                                                      |
| srcPath                   | SRC_PATH                  | The project files directory relative to project root.                                                                                                               | `/src`                                                                       |                                                                                                                                                                       |
| staticPath                | STATIC_PATH               | The directory where Webpack will deposit the resulting project relative to project root.                                                                            | `/public`                                                                    |                                                                                                                                                                       |
| stylelint                 | STYLELINT                 | Path to CSS stylelint settings                                                                                                                                      | `/.stylelintrc` or defaults packaged with **Webpack Digest**                 |                                                                                                                                                                       |
| stylelintIgnore           | STYLELINT_IGNORE          | Path to CSS stylelint ignore settings                                                                                                                               | `/.stylelintignore` or defaults comes packaged with **Webpack Digest**       |                                                                                                                                                                       |
| testConfig                | TESTCONFIG                | Path to optional script that is picked up by the provided Jest config to setup additional test suites such as enzyme                                                | `/testconfig.js`                                                             |                                                                                                                                                                       |
| tsconfig                  | TSCONFIG                  | Path to typescript config                                                                                                                                           | `/tsconfig.json` or defaults packaged with **Webpack Digest**                |                                                                                                                                                                       |
| tslint                    | TSLINT                    | Path to typescript tslint config                                                                                                                                    | `/tslint.json` or defaults packaged with **Webpack Digest**                  |                                                                                                                                                                       |

## Platforms

### Typescript

To use [Typescript](http://www.typescriptlang.org/), include the `typescript`
option under `platforms`:
```json
'/webpack.digest.config.json'

{
  "platforms": {
    "typescript": true
  }
}
```

The **Webpack Digest** configuration processes Typescript files through Webpack
just like ordinary Javascript. No additional build step is required and all the
same Webpack features work as expected. For `typescript` IDE integration, extend
the provided `webpack-digest` config by creating a `tsconfig.json` file in the
root of your project:

```json
'/tsconfig.json'

{
  "extends": "./node_modules/webpack-digest/lib/typescript/tsconfig.json",
}
```

However, with this default `tsconfig.json`, typescript files are not able to
import Javascript. The setting `noImplicitAny` is set to `true` and that prevents
javascript files from being imported within typescript files. Set
`noImplicitAny` to `false` in your `tsconfig.json` to enable importing
javascript:

```json
'/tsconfig.json'

{
  "extends": "./node_modules/webpack-digest/lib/typescript/tsconfig.json",
  "compilerOptions": {
    "noImplicitAny": false
  }
}
```

However it is dangerous to turn off `noImplicitAny`. Only use if you *must*
import javascript. If so, work towards converting all your code to Typescript.
It is also possible to import javascript using `require()`, but this will
prevent tree shaking.

At this time, there are several ***gotcha's*** with Typescript such as `.css`,
`.scss`, and `.json` imports, and using Webpack's `System` API. These
can be resolved in a `.d.ts` file. Regrettably, it is not possible with the
shared `tsconfig.json` to include a default `global.d.ts` file while also
excluding implicit `node_modules` definitions. You may create a `global.d.ts`
file in the root of your project or source path and add the following helpful
entries:

```ts
`/src/global.d.ts`

declare module '*.css';
declare module '*.scss';

declare var System: {
  import: any
};

declare module "*.json" {
    const value: any;
    export default value;
}

declare var BUILD: {
  DATE: string;
}

declare var PACKAGE: {
  DESCRIPTION: string,
  NAME: string,
  TITLE: string,
  VERSION: string
}
```

### CSS Modules

CSS Module support must be explicitly activated.

```json
'/webpack.digest.config.json'

{
  "platforms": {
    "cssModules": true,
  }
}
```

When CSS modules are used, a CSS file can be set explicitly global via the
`.g.css` extension. For example, `styles.g.css` would be loaded globally, while
`styles.css` would load as a CSS module. CSS files from `node_modules` are
always global.

*When using React,
[React CSS modules Babel plugin](https://github.com/gajus/babel-plugin-react-css-modules)
is included and the styleName property will become available in your
components*

## Extending

### Webpack Config

It's easy to extend the **Webpack Digest** *Webpack* configuration. Simply
edit the `webpack.config.js` in the root of your project and modify the imported
 the `webpack-digest` `webpackDigest` object to your liking. Projects such as
[webpack-merge](https://www.npmjs.com/package/webpack-merge) and
[webpack-config](https://www.npmjs.com/package/webpack-config) can help extend
the `webpack-digest` config object.

```js
'/webpack.config.js'

var webpackDigest = require('webpack-digest/lib/webpack.config.js');

function extend(config) {
  /* Modify the config */
  return config;
}

module.exports = extend(webpackDigest);
```

If you use a different file name or path for your `webpack.config.js`, you can
refer to your extended config explicitly in your build scripts with `webpack`'s
`--config` option:

```json
'/package.json'

{
  ...
  "scripts": {
    ...
    "build": "webpack --config webpack.config.js --progress --colors --display-error-details"
  }
}
```

### Express

It's also easy to extend the default express app configuration. Simply create a
`server.extend.js` file and import `webpack-digest`'s `hot.js`. After extending,
serve express or use the provided `server.js`:

***Note that to avoid complications with non-root routes, the root `/` route and
HTML5 <code>/&ast;</code> catch-all are not implemented in the default `hot.js` and will have
to be provided. See example below.***

```js
'/server.extend.js'

const path = require('path');
const express = require('express');
const proxy = require('http-proxy-middleware');
const hot = require('webpack-digest/lib/express/hot.js');

const app = express();

/*
  Use provided  `hot.js` to use `webpack-dev-middleware`,
  `webpack-hot-middleware`, and `webpack-dashboard` setup
*/
hot(app);

// *** Root route ***
app.use(
  '/',
  express.static(path.join('public'))
);

// *** For HTML5 Routing ***
app.all(
  '/*',
  function (request, response) {
    response.sendFile(path.join('public', 'index.html'));
  }
);

app.get('/env', function (request, response){
  response.json({
    env: 'qa'
  })
})

app.use('/api', proxy({
  target: 'http://localhost:9090',
  changeOrigin: true
}))

/* Use provided `server.js` to host */
const server = require('webpack-digest/lib/express/server.js');

server(app);

module.exports = app;
```

Then remember to reference your `server.extend.js` in the projects
`package.json` scripts:

```json
'/package.json'

{
  ...
  "scripts": {
    "start": "node server.extend.js",
    "start:dev": "cross-env NODE_ENV='development' node server.extend.js"
    ...
  }
}
```

### Jest

[Jest](https://facebook.github.io/jest/) can be tricky to setup in this kind of
configuration because Webpack and Babel configurations are not in the root
directory. A Jest configuration is provided but it is not extendible. However,
it can be copied to your root directory and modified further if needed. The
provided Jest config does work with Typescript.To use the provided Jest
configuration, simply include the following scripts in your
`package.json`**\***:

```json
'/package.json'

{
  ...
  "scripts": {
    ...
    "test": "jest --config node_modules/webpack-digest/lib/jest/config.js --no-cache --coverage",
    "test:dev": "jest --config node_modules/webpack-digest/lib/jest/config.js --no-cache --watch"
  }
}
```

The `TESTCONFIG` option is for additional test suite configuration
when using the provided Jest config. By default it will look for a
`testconfig.js` file in the root of the project. This file is run via Jests
[setupFiles](https://facebook.github.io/jest/docs/en/configuration.html#setupfiles-array)
option. This is required when using some libraries like
[`enzyme`](http://airbnb.io/enzyme/). For example:

```js
'/testconfig.js'

import {configure} from 'enzyme';
import Adapter from 'enzyme-adapter-react-15';

configure({adapter: new Adapter()});
```

### Nightwatch

The provided [Nighwatch](http://nightwatchjs.org/) configuration is extendable.
`webpack-digest/lib/nightwatch/conf.js` exports a config object which can be
further modified. The default config includes support for Firefox and Chrome.
PhantomJS is no longer supported.

Before running Nightwatch, the selenium binaries and browser drivers must be
downloaded first. (***Note***: selenium requires Java be installed and
`JAVA_PATH` setup in the local environment) The binaries are installed within
`node_modules`, so any time that directory is removed, this script must be run
again.

Nightwatch tests may be run after the binaries have been installed. The default
Nightwatch config will look for test files within the `__e2e__` directory at the
root of the project, unless overridden by the `E2E` property.

The following are examples using the provided default `nightwatch` config:

```JSON
'/package.json'

{
  ...
  "scripts": {
    "nightwatch:install": "node node_modules/webpack-digest/lib/nightwatch/install.js",
    "nightwatch": "sleep 1 && nightwatch --config node_modules/webpack-digest/lib/nightwatch/conf.js --env chrome",
    "nightwatch:ci": "sleep 1 && SELENIUM_START=false nightwatch --config node_modules/webpack-digest/lib/nightwatch/conf.js --env chrome"
  }
}
```

Selenium continuous integration test patterns will vary from team to team.
`webpack-digest` uses Atlassian's
[`docker-node-jdk-chrome-firefox`](https://bitbucket.org/atlassian/docker-node-jdk-chrome-firefox)
docker container. See the project's GitLab
[CI](https://gitlab.com/wallzero/webpack-digest/blob/master/.gitlab-ci.yml) and
[package](https://gitlab.com/wallzero/webpack-digest/blob/master/package.json)
scripts for examples.

### ESLINT / TSLINT / STYLELINT

[`eslint`](https://eslint.org/), [`tslint`](https://palantir.github.io/tslint/),
and [`stylelint`](https://stylelint.io/) run during every `webpack` build.
However, it is also common for IDE's to have built in linters which load the
respective lint config file. These three linters offer `extends` options, which
allow a config file to extend another. Using `extends`, you can include the
following lint files to extend the configs provided by **Webpack Digest** to the
root of your project. Additionally, this is how you would add new rules or
override the defaults.

```json
'/.eslintrc'

{
  "extends": "./node_modules/webpack-digest/lib/lint/.eslintrc"
}
```

```json
'/tslint.json'

{
  "extends": "./node_modules/webpack-digest/lib/lint/tslint.json"
}
```

```json
'/.stylelintrc'

{
  "extends": "./node_modules/webpack-digest/lib/lint/.stylelintrc"
}
```

**Note**: you do ***not*** have to use or extend the **Webpack Digest** rules.
During a build, when these files are present in the root of your project, they
will be used instead of the defaults. Meaning if your project includes one of
these configs and omits the `extends`, you are starting with a blank slate.

## License

GPLv3
